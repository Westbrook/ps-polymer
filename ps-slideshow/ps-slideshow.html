<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../ps-image-service/ps-image-service.html">
<link rel="import" href="../ps-gallery-service/ps-gallery-service.html">
<link rel="import" href="../ps-collection-children-service/ps-collection-children-service.html">
<link rel="import" href="../ps-image/ps-image.html">
<!--
Element displaying a PhotoShelter.com slideshow of images

##### Example

<ps-slideshow></ps-slideshow>

@element ps-slideshow
@blurb Element displaying a PhotoShelter.com slideshow of images
@status alpha
@homepage #
-->

<polymer-element name="ps-slideshow" attributes="C_ID G_IDs G_ID I_IDs images I_ID image gallery autoplay sizing urlFormat">
    <template>
    <style>
    :host {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        overflow: hidden;
    }
    .stage {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        overflow: hidden;
    }
    ps-image {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    .anim {
        -webkit-transition-property: all;
        -moz-transition-property: all;
        -o-transition-property: all;
        transition-property: all;
        -webkit-transition-duration: 0.3s;
        -moz-transition-duration: 0.3s;
        -o-transition-duration: 0.3s;
        transition-duration: 0.3s;
        -webkit-transition-timing-function: ease-in-out;
        -moz-transition-timing-function: ease-in-out;
        -o-transition-timing-function: ease-in-out;
        transition-timing-function: ease-in-out;
    }
    [data-transition=slide] .prev,
    [data-transition=slide] .preload-prev,
    [data-transition=slide] .current.back {
        -webkit-transform: translate3d(-100%, 0, 0);
        -moz-transform: translate3d(-100%, 0, 0);
        -ms-transform: translate3d(-100%, 0, 0);
        -o-transform: translate3d(-100%, 0, 0);
        transform: translate3d(-100%, 0, 0);
    }
    [data-transition=slide] .next,
    [data-transition=slide] .preload-next,
    [data-transition=slide] .current.forward {
        -webkit-transform: translate3d(100%, 0, 0);
        -moz-transform: translate3d(100%, 0, 0);
        -ms-transform: translate3d(100%, 0, 0);
        -o-transform: translate3d(100%, 0, 0);
        transform: translate3d(100%, 0, 0);
    }
    [data-transition=slide] .prev.forward,
    [data-transition=slide] .next.back,
    .current {
        -webkit-transform: translate3d(0, 0, 0);
        -moz-transform: translate3d(0, 0, 0);
        -ms-transform: translate3d(0, 0, 0);
        -o-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
    }
    button {
        -webkit-appearance: none;
        border: none;
        line-height: inherit;
        outline: none;
        padding: 0;
        text-decoration: none;
        cursor: pointer;
        background: transparent;
        color: #fff;
        width: 50%;
    }
    .advance {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
    }
    .retreat {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
    }
    </style>

    <template if="{{!!G_ID}}">
        <ps-gallery-service id="service-gallery" gallery="{{gallery}}" G_ID='{{G_ID}}' extends="{{extendsGal}}"></ps-gallery-service>
    </template>

    <template if="{{!!C_ID}}">
        <ps-collection-children-service id="service-collection" collectionChildren="{{collectionChildren}}" C_ID='{{C_ID}}' extends="{{extendsClc}}"></ps-collection-children-service>
    </template>

    <div class="stage" data-transition="{{transition}}">
        <ps-image onstage class="current" size="1440x1440" sizing="{{sizing}}"></ps-image>
        <ps-image class="preload-prev" size="1440x1440" sizing="{{sizing}}"></ps-image>
        <ps-image class="preload-next" size="1440x1440" sizing="{{sizing}}"></ps-image>
        <ps-image onstage class="prev" size="1440x1440" sizing="{{sizing}}"></ps-image>
        <ps-image onstage class="next" size="1440x1440" sizing="{{sizing}}"></ps-image>
    </div>

    <template if="{{!!set && set.length > 1}}">
        <button class="advance" on-tap={{forward}}></button>
        <button class="retreat" on-tap={{back}}></button>
    </template>

</template>

<script>
Polymer('ps-slideshow',{
    transition: 'slide',
    sizing: 'contain',
    created: function() {
        /**
        * The `gallery` attribute defines the PhotoShelter gallery to be displayed.
        *
        * @attribute gallery
        * @type object
        * @default {}
        */
        this.gallery = {};
        /**
        * The `extendsGal` attribute outlines the extends of the ps-gallery-service tag to support the content delivered.
        *
        * @attribute extendsGal
        * @type array
        * @default ["KeyImage", "GalleryImage", "ImageLink", "Image", "Iptc", "Exif", "Profile"]
        */
        this.extendsGal = [
            "KeyImage",
            "GalleryImage",
            "ImageLink",
            "Image",
            "Iptc",
            "Exif",
            "Profile"
        ];
        /**
        * The `extendsGal` attribute outlines the extends of the ps-gallery-service tag to support the content delivered.
        *
        * @attribute extendsGal
        * @type array
        * @default ["KeyImage", "ImageLink", "Image", "Iptc", "Exif", "Profile"]
        */
        this.extendsClc = [
            "KeyImage",
            "ImageLink",
            "Image",
            "Iptc",
            "Exif",
            "Profile"
        ];

        this.cleanups = [
            {
                selector: '.current.forward',
                dest: 'next',
                newImage: false
            },
            {
                selector: '.current.back',
                dest: 'prev',
                newImage: false
            },
            {
                selector: '.prev.forward',
                dest: 'current',
                newImage: false
            },
            {
                selector: '.prev.back',
                dest: 'next',
                newImage: true
            },
            {
                selector: '.next.forward',
                dest: 'prev',
                newImage: true
            },
            {
                selector: '.next.back',
                dest: 'current',
                newImage: false
            }
        ];

        this.current = 0;
    },
    setupImages: function() {
        var image;
        if (this.I_ID === 'random') {
            this.current = Math.floor(Math.random() * this.images.length);
        } else if (this.I_ID) {
            for (var i = 0, ct = this.images.length; i < ct; i++) {
                image = this.images[i];
                if (image.image_id === this.I_ID) {
                    this.current = i;
                    break;
                }
            }
        } else {
            this.current = 0;
        }
        this.shadowRoot.querySelector('.current').image = this.getImage('current');
        this.shadowRoot.querySelector('.next').image = this.getImage('next');
        this.shadowRoot.querySelector('.prev').image = this.getImage('prev');
        this.shadowRoot.querySelector('.preload-prev').image = this.getImage('preload-prev');
        this.shadowRoot.querySelector('.preload-next').image = this.getImage('preload-next');
    },
    setupI_IDs: function() {
        var iid;
        if (this.I_ID === 'random') {
            this.current = Math.floor(Math.random() * this.I_IDs.length);
        } else if (this.I_ID) {
            for (var i = 0, ct = this.I_IDs.length; i < ct; i++) {
                iid = this.I_IDs[i];
                if (iid === this.I_ID) {
                    this.current = i;
                    break;
                }
            }
        }
        this.shadowRoot.querySelector('.current').I_ID = this.getImage('current');
        this.shadowRoot.querySelector('.next').I_ID = this.getImage('next');
        this.shadowRoot.querySelector('.prev').I_ID = this.getImage('prev');
        this.shadowRoot.querySelector('.preload-prev').I_ID = this.getImage('preload-prev');
        this.shadowRoot.querySelector('.preload-next').I_ID = this.getImage('preload-next');
    },
    setupG_IDs: function() {
        var iid;
        if (this.I_ID === 'random') {
            this.current = Math.floor(Math.random() * this.I_IDs.length);
        } else if (this.I_ID) {
            for (var i = 0, ct = this.I_IDs.length; i < ct; i++) {
                iid = this.I_IDs[i];
                if (iid === this.I_ID) {
                    this.current = i;
                    break;
                }
            }
        }
        this.shadowRoot.querySelector('.current').G_ID = this.getImage('current');
        this.shadowRoot.querySelector('.next').G_ID = this.getImage('next');
        this.shadowRoot.querySelector('.prev').G_ID = this.getImage('prev');
        this.shadowRoot.querySelector('.preload-prev').G_ID = this.getImage('preload-prev');
        this.shadowRoot.querySelector('.preload-next').G_ID = this.getImage('preload-next');
    },
    galleryChanged: function() {
        if (typeof this.gallery.GalleryImage !== 'undefined') {
            this.images = this.gallery.GalleryImage;
            this.type = 'image';
            this.set = this.images;
            this.setupImages();
        }
    },
    I_IDChanged: function() {
        if (!!this.type && this.I_ID === this.getImage('next').image_id) this.forward();
        else if (!!this.type && this.I_ID === this.getImage('prev').image_id) this.back();
        else if (!!this.images && this.images.length) {
            this.type = 'image';
            this.set = this.images;
            this.setupImages();
            this.autoplayCheck();
        }
    },
    I_IDsChanged: function() {
        if (!!this.I_IDs && this.I_IDs.length) {
            this.type = 'I_ID';
            this.set = this.I_IDs;
            this.setupI_IDs();
            this.autoplayCheck();
        }
    },
    G_IDsChanged: function() {
        if (!!this.G_IDs && this.G_IDs.length) {
            this.type = 'G_ID';
            this.set = this.G_IDs;
            this.setupG_IDs();
            this.autoplayCheck();
        }
    },
    collectionChildrenChanged: function() {
        var images = [];
        for (var i = 0, ct = this.collectionChildren.length; i < ct; i++) {
            if (this.collectionChildren[i].KeyImage)
                images.push(this.collectionChildren[i].KeyImage);
        }
        this.images = images;
        this.type = 'image';
        this.set = this.images;
        this.setupImages();
        this.autoplayCheck();
    },
    autoplayChanged: function() {
        this.autoplayCheck();
    },
    autoplayCheck: function() {
        if (this.autoplay &&
                ((!!this.I_IDs && this.I_IDs.length > 1) ||
                (!!this.images && this.images.length > 1))) {
            if (!this.animLoop)
                this.animLoop = window.requestAnimationFrame(this.auto.bind(this));
        }
    },
    auto: function() {
        this.loop = this.loop || 0;
        this.loop++;
        if (this.loop === 300) {
            this.forward();
            this.loop = 0;
        }
        this.animLoop = window.requestAnimationFrame(this.auto.bind(this));
    },
    goToUrl: function(image) {
        var urlParts = this.urlFormat.split('/'),
            property, value;
        for (var i = 0, ct = urlParts.length; i < ct; i++) {
            if (urlParts[i][0] === ':') {
                property = urlParts[i].substring(1).split('.');
                value = image[property[0]];
                for (var p = 1, pt = property.length; p < pt; p++) {
                    value = value[property[p]];
                }
                if (value) urlParts[i] = value.replace(/ /g,'-');
            }
        }
        if (urlParts[0] !== '#!')
            window.location = urlParts.join('/');
        else {
            window.location.hash = urlParts.join('/')
        }
    },
    back: function(e) {
        if (typeof e === 'object' && !!this.urlFormat)  return this.goToUrl(this.getImage('prev'));
        var images = this.shadowRoot.querySelectorAll('[onstage]');
        this.current = this.getIdx(-1);
        this.shadowRoot.querySelector('.current').addEventListener('transitionend', this.cleanup.bind(this), false);
        for (var i = 0, ct = images.length; i < ct; i++) {
            images[i].classList.add('anim','forward');
        }
    },
    forward: function(e) {
        if (typeof e === 'object' && !!this.urlFormat)  return this.goToUrl(this.getImage('next'));
        var images = this.shadowRoot.querySelectorAll('[onstage]');
        this.current = this.getIdx(1);
        this.shadowRoot.querySelector('.current').addEventListener('transitionend', this.cleanup.bind(this), false);
        for (var i = 0, ct = images.length; i < ct; i++) {
            images[i].classList.add('anim','back');
        }
    },
    cleanup: function() {
        var pane,
            type = this.type;
        this.shadowRoot.querySelector('.current').removeEventListener('transitionend', this.cleanup, false);
        for (var i = 0, ct = this.cleanups.length; i < ct; i++) {
            pane = this.shadowRoot.querySelector(this.cleanups[i].selector);
            if (pane !== null) {
                pane.className = this.cleanups[i].dest;
                if (this.cleanups[i].newImage) {
                    pane[type] = this.getImage(this.cleanups[i].dest);
                }
            }
        }
        this.image = this.getImage('current');
        this.shadowRoot.querySelector('.preload-prev')[type] = this.getImage('preload-prev');
        this.shadowRoot.querySelector('.preload-next')[type] = this.getImage('preload-next');
    },
    getIdx: function(offset, I_IDs) {
        var index = this.current + offset,
            set = this.set;
        if (index < 0) {
            index = set.length + index;
        } else if (index >= set.length) {
            index = index - set.length;
        }
        return index;
    },
    getImage: function(step) {
        var index,
            set = this.set;
        switch (step) {
        case 'current':
            return set[this.current];
        case 'next':
            return set[this.getIdx(1)];
        case 'prev':
            return set[this.getIdx(-1)];
        case 'preload-next':
            return set[this.getIdx(2)];
        case 'preload-prev':
            return set[this.getIdx(-2)];
        }
    }
});
</script>
</polymer-element>
